<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Forecast Chart</title>
  <link rel="icon" href="https://flaire.fi/wp-content/uploads/2024/01/cropped-flaire-favicon-32x32.png" sizes="32x32" />
  <link rel="icon" href="https://flaire.fi/wp-content/uploads/2024/01/cropped-flaire-favicon-192x192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="https://flaire.fi/wp-content/uploads/2024/01/cropped-flaire-favicon-180x180.png" />
  <meta name="msapplication-TileImage" content="https://flaire.fi/wp-content/uploads/2024/01/cropped-flaire-favicon-270x270.png" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* Default light theme styles */
    body {
      background-color: #f4f4f9;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      transition: background-color 0.2s, color 0.2s;
      position: relative;
    }

    /* Header container for title */
    .header-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
    }

    /* Logo styling and positioning */
    .logo {
      position: absolute;
      left: 20px;
      top: 20px;
      height: clamp(30px, 5vw, 50px);
      width: auto;
      transition: filter 0.2s;
    }

    /* Invert logo colors for light theme */
    body.light-theme .logo {
      filter: invert(1);
    }

    body.dark-theme .logo {
      filter: none;
    }

    h1 {
      color: #000;
      font-weight: 300;
      margin: 0;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .controls label, .controls input, .controls button {
      font-size: 16px;
    }

    .controls button {
      padding: 8px 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      background-color: #fff;
      color: #333;
      cursor: pointer;
    }

    #chart-container {
      width: 95%;
      max-width: 1200px;
      height: 60vh;
    }

    /* Dark theme styles */
    body.dark-theme {
      background-color: #111;
      color: #eee;
    }

    body.dark-theme h1 {
      color: #fff;
    }

    body.dark-theme .controls button {
      background-color: #333;
      color: white;
      border: 1px solid #555;
    }
  </style>
</head>
<body class="light-theme">
  <!-- Logo positioned absolutely -->
  <img src="https://flaire.fi/wp-content/uploads/2024/04/Flaire-logo-white.png" alt="Logo" class="logo" />

  <!-- Header container for title -->
  <div class="header-container">
    <h1>Flaire Information Platform</h1>
  </div>

  <div class="controls">
    <label for="start">Start:</label>
    <input type="date" id="start">
    <label for="end">End:</label>
    <input type="date" id="end">
    <button id="load-button">Load Forecast</button>
    <button id="theme-toggle">Toggle Theme</button>
  </div>
  <div id="chart-container">
    <div id="chart" style="width:100%;height:100%;"></div>
  </div>
  <script>
    const chartDiv = document.getElementById('chart');
    const startInput = document.getElementById('start');
    const endInput = document.getElementById('end');
    const loadButton = document.getElementById('load-button');
    const themeToggleButton = document.getElementById('theme-toggle');

    // Default to light theme
    let currentTheme = 'light';

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    async function loadForecast(start = null, end = null) {
      let url = "/forecast";
      if (start && end) {
        url += `?start=${start}&end=${end}`;
      }
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        const trace = {
          x: data.map(d => d.timestamp),
          y: data.map(d => d.value),
          type: "scatter",
          mode: "lines+markers",
          name: "Forecast",
          fill: 'tozeroy',
          fillcolor: 'rgba(74, 144, 226, 0.2)',
          line: {
            color: 'rgb(74, 144, 226)',
            width: 3,
            shape: 'spline'
          },
          marker: { size: 6, symbol: 'circle' },
          hovertemplate: '<b>%{y:.2f}</b> at %{x|%H:%M}<extra></extra>'
        };

        // Define grid color for the light theme
        const lightThemeGridColor = '#cccccc';

        // Layout uses the currentTheme variable
        const layout = {
          template: currentTheme === 'dark' ? 'plotly_dark' : 'plotly_white',
          title: "Forecast Data",
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          xaxis: {
            title: "Time",
            rangeslider: { visible: true },
            gridcolor: currentTheme === 'light' ? lightThemeGridColor : undefined
          },
          yaxis: {
            title: "Value",
            gridcolor: currentTheme === 'light' ? lightThemeGridColor : undefined
          },
          margin: { l: 50, r: 20, t: 60, b: 70 },
          autosize: true
        };

        const config = { responsive: true, displaylogo: false };
        Plotly.newPlot(chartDiv, [trace], layout, config);
      } catch (error) {
        chartDiv.innerHTML = `<p style="color:red;">Could not load forecast data. ${error.message}</p>`;
        console.error("Error loading forecast:", error);
      }
    }

    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.classList.toggle('dark-theme');

      const newTemplate = currentTheme === 'dark' ? 'plotly_dark' : 'plotly_white';
      const newGridColor = currentTheme === 'light' ? '#cccccc' : undefined;

      Plotly.relayout(chartDiv, {
        template: newTemplate,
        'xaxis.gridcolor': newGridColor,
        'yaxis.gridcolor': newGridColor
      });
    }

    // --- Event Listeners ---
    loadButton.addEventListener('click', () => {
      loadForecast(startInput.value, endInput.value);
    });

    themeToggleButton.addEventListener('click', toggleTheme);

    function initialize() {
      const today = new Date();
      const tomorrow = new Date();
      tomorrow.setDate(today.getDate() + 1);
      startInput.value = formatDate(today);
      endInput.value = formatDate(tomorrow);

      loadForecast(startInput.value, endInput.value);
    }

    initialize();
  </script>
</body>
</html>
